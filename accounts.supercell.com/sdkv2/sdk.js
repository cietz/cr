"use strict";(()=>{var I=Object.defineProperty,O=Object.defineProperties;var k=Object.getOwnPropertyDescriptors;var h=Object.getOwnPropertySymbols;var y=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var m=(i,t,e)=>t in i?I(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,g=(i,t)=>{for(var e in t||(t={}))y.call(t,e)&&m(i,e,t[e]);if(h)for(var e of h(t))L.call(t,e)&&m(i,e,t[e]);return i},v=(i,t)=>O(i,k(t));var c=(i,t,e)=>new Promise((a,s)=>{var p=o=>{try{r(e.next(o))}catch(d){s(d)}},n=o=>{try{r(e.throw(o))}catch(d){s(d)}},r=o=>o.done?a(o.value):Promise.resolve(o.value).then(p,n);r((e=e.apply(i,t)).next())});var u={ssoBaseUrl:"https://accounts.supercell.com",debugLogEnabled:!1,accountIdCookieName:"scsso_scid"};var S=u,b=60*1e3,D=5*b,w=10*b,K=100,f=1e3,A=1e4,C=i=>{let t=document.cookie.split(";").find(e=>e.trim().startsWith(i+"="));return t?t.split("=")[1]:null},E=(i,t)=>i+Math.random()*(t-i),R=()=>document.visibilityState==="visible"||document.hasFocus(),l=class{constructor(t){let e=typeof t.debugLogEnabled!="undefined"?t.debugLogEnabled:S.debugLogEnabled;this.options=v(g({},t),{ssoBaseUrl:t.ssoBaseUrl||S.ssoBaseUrl,accountIdCookieName:t.accountIdCookieName||S.accountIdCookieName,debugLogEnabled:e}),this.localStorageKey="scsso-"+t.clientId,this.state={failedTicks:0,lastRevalidationTime:this.readLastValidationTimestamp(),stopped:!1,timerId:setTimeout(()=>this.tick(),0),revalidationInterval:E(D,w)}}revalidationInterval(){return this.state.revalidationInterval}close(){this.state.stopped=!0,clearTimeout(this.state.timerId),this.debugLog("SSOSDK closed")}tick(){return c(this,null,function*(){let t=!1;try{if(!R())return;let e=this.options.currentAccountId(),a=C(this.options.accountIdCookieName);if(e!==null&&a===null){this.state.stopped=!0,yield this.options.onSessionInvalid();return}if(e!==a){this.state.stopped=!0,yield this.options.onAccountChanged();return}let s=new Date().getTime();if(e!==null&&s-this.state.lastRevalidationTime>=this.state.revalidationInterval){let n=yield this.validateSession();this.debugLog("Session validation result: "+n),n==="Ok"?this.updateLastValidationTimestamp(s):n==="SessionInvalid"?(this.state.stopped=!0,yield this.options.onSessionInvalid()):t=!0}}catch(e){t=!0,this.debugLog("Exception during tick:",e)}finally{if(!this.state.stopped){let e=K;if(t){this.state.failedTicks++;let a=Math.random(),s=f*1.5**this.state.failedTicks;e=Math.round(Math.min(A,Math.max(f,s*a))),this.debugLog("Tick failed, retrying in "+e+"ms")}else this.state.failedTicks=0;this.state.timerId=setTimeout(()=>this.tick(),e)}}})}debugLog(t,e){if(this.options.debugLogEnabled){let a=new Date().toISOString();e?console.log("["+a+"][SSOSDK]: "+t,e):console.log("["+a+"][SSOSDK]: "+t)}}readLastValidationTimestamp(){let t;try{t=localStorage.getItem(this.localStorageKey)}catch(e){this.debugLog("Local storage not available",e)}if(t){let e=JSON.parse(t);if(e.lastValidatedAt)return e.lastValidatedAt}return 0}updateLastValidationTimestamp(t){try{localStorage.setItem(this.localStorageKey,JSON.stringify({lastValidatedAt:t}))}catch(e){this.debugLog("Local storage not available",e)}this.state.lastRevalidationTime=t}validateSession(){return c(this,null,function*(){let t=yield fetch(this.options.ssoBaseUrl+"/oauth/sso/validate",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:this.options.clientId}),credentials:"include"}),e=yield t.json();return t.ok&&e.ok?"Ok":t.status==401?"SessionInvalid":"Error"})}};window.SSOSDK=l;})();
